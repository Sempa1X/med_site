{% extends 'base/base.html' %}


{% block content %}

<div class="container" id='cont'>
    <div class="row mb-5">
        <div class="col">
            <form id='searchFormtest' action="/reception/reception_process">
                <div id="sandbox-container" class="d-flex justify-content-center"></div>
            </form>
        </div>
    </div>
      
      <!-- Modal -->
    <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="modal_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_label">Расписание</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form_modal" action="/schedule/add_schedule" onsubmit="add_schedule(); return false;">
                        <select name="doctor" id='sel_doc' class="form-select" aria-label="Пример выбора по умолчанию" required>
                            <option value="none"disabled required>Выбор доктора...</option>
                        </select>
                        <br>
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1">Номер кабинета</span>
                            <input name="office" id='office' type="number" aria-label="First name" class="form-control" onkeypress="return event.charCode >= 48" min="1" max="24" required>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon3">Время</span>
                            <input id="after" type="number" aria-label="First name" onkeypress="return event.charCode >= 48" min="1" max="24" class="form-control after" required>
                            <input id="before" type="number" aria-label="Last name" onkeypress="return event.charCode >= 48" min="1" max="24" class="form-control before" required>
                        </div>
                        <select name="step" id='step' class="form-select" aria-label="Пример выбора по умолчанию" required>
                            <option value="0" disabled>Выберите промежуток</option>
                            <option value="15">15 мин</option>
                            <option value="30">30 мин</option>
                            <option value="45">45 мин</option>   
                            <option value="60">60 мин</option>
                        </select>
                        <br>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-dark">Создать</button>
                        </div>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.ru.min.js"></script>

<script>
    after.oninput = function () {
        if (this.value.length > 2) {
            this.value = this.value.slice(0,2); 
        }
    }

    before.oninput = function () {
        if (this.value.length > 2) {
            this.value = this.value.slice(0,2); 
        }
    }

    function getSchedule(obj){
        let start = document.getElementById("after").value;
        let end = document.getElementById("before").value;
        let _start = moment(start, 'HH:mm');
        let _end = moment(end, 'HH:mm');
        
        let result = [];
        
        while (_start <= _end) {
            result.push(_start.format('HH:mm'));
            _start.add(obj.value, 'minutes');
        }
        console.log(result);
        // return result;
    }
    function add_schedule() {
        
        var $form = $( '#form_modal' ),
            doc_id = $form.find( "#sel_doc" ).val(),
            office = $form.find( "#office" ).val(),
            start = $form.find( "#after" ).val(),
            end = $form.find( "#before" ).val(),
            step = $form.find( "#step" ).val(),
            url = $form.attr( "action" );
        console.log(doc_id, office, start, end, step);
        // getSchedule(step);
        // console.log(test_list);
        // Send the data using post
        // var posting = $.post(url, { date: ["хуй"] } );
    
        // Put the results in a div
        // posting.done(function( data ) {
        //     if (data.success == "false") {
        //         toastr["warning"]("Не найдены записи на сегодня.", "Предупреждение!");
        //     }
        //     else {
        //         for (var a = 0; a < data.data.length; a++) {
        //             createForm(data);
        //             console.log(data.data[a].full_name + a)
        //             console.log(data.data[a].trust_factor + a)
        //             console.log(data.data[a].role + a)
        //             console.log(data.data[a].comment + a)
        //             console.log(data.data[a].phone + a)

        //         }
        //     }
        // });
    };
</script>   

<script>
    $(document).ready(function(){
      $("#myBtn").click(function(){
        $("#myModal").modal();
      });
    });
</script>
    

<script>
    $(document).ready(function() { 
        get_doctors();
    });

    function get_doctors() {
        url = '/reception/get_doctors'
        var posting = $.post( url );

        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["error"]("Произошла ошибка, пожалуйста попробуйте еще раз или обратитесь к администратору.", "Ошибка!");
            }
            else {
                toastr["success"]("Успешно!");
                createForm(data.doctors);
            }
        });
    };

    $('#sandbox-container').datepicker({
        format: "yyyy-mm-dd",
        startView: 2,
        maxViewMode: 2,
        todayBtn: "linked",
        language: "ru",
        daysOfWeekDisabled: "0",
        autoclose: true,
        todayHighlight: true,
    }).on('changeDate', showTestDate);
    function showTestDate() {
        console.log($('#sandbox-container').datepicker('getFormattedDate'));

        event.preventDefault();
    
        var $form = $( '#searchFormtest' ),
            term = $form.find( "#sandbosssx-container" ).val(),
            url = $form.attr( "action" );
    
        // Send the data using post
        var posting = $.post(url, { date: $('#sandbox-container').datepicker('getFormattedDate') } );
    
        // Put the results in a div
        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["warning"]("Не найдены записи на сегодня.", "Предупреждение!");
            }
            else {
                for (var a = 0; a < data.data.length; a++) {
                    createForm(data);
                    console.log(data.data[a].full_name + a)
                    console.log(data.data[a].trust_factor + a)
                    console.log(data.data[a].role + a)
                    console.log(data.data[a].comment + a)
                    console.log(data.data[a].phone + a)

                }
            }
        });
    };

    function delBlock() {
        if ($('#data_place').length) {
            $("#data_place").empty();
        }
    }
    
    function createForm(data) {
        delBlock()
        $("<div/>").attr({id: 'data_place'}).appendTo('#cont');
        $("<div/>").attr({id: 'row', class: 'row'}).appendTo('#data_place');
        for (let count = 0; count < data.length; count++) {
            console.log(count)
            $("<option/>").attr({id: `doc_${data[count].doc_id}`,value: data[count].doc_id}).appendTo(`#sel_doc`);
            document.getElementById(`doc_${data[count].doc_id}`).textContent = data[count].doc_full_name;
            $("<div/>").attr({id: `col_${count}`, class: 'col-sm-3'}).appendTo(`#row`);
            $("<div/>").attr({id: `head_${count}`}).appendTo(`#col_${count}`);
            $("<p/>").attr({id: `head_fio_${count}`, class: 'text-center mb-1'}).appendTo(`#head_${count}`);
            document.getElementById(`head_fio_${count}`).textContent = data[count].doc_full_name;
            $("<p/>").attr({id: `head_office_${count}`, class: 'text-center'}).appendTo(`#head_${count}`);
            if (data[count].records.length > 0) {
                document.getElementById(`head_office_${count}`).textContent = `Кабинет №${data[count].records[0].office}`;
                $("<div/>").attr({id: `scroll_${count}`, class: 'overflow-auto', style: "max-height: 40vh; padding-right: 5px;"}).appendTo(`#col_${count}`);
                for (item_count = 0; item_count < data[count].records.length; item_count++) {
                    $("<div/>").attr({id: `scroll_item_${item_count}`, class: 'input-group input-group-sm mb-2'}).appendTo(`#scroll_${count}`);
                    // if (data[count].records.date == )
                    $("<span/>").attr({id: `scroll_item_span_${item_count}`, class: 'input-group-text btn-secondary text-white'}).appendTo(`#scroll_item_${item_count}`);
                    document.getElementById(`scroll_item_span_${item_count}`).textContent = 11;
                    $("<input/>").attr({id: `scroll_item_input_${item_count}`, class: 'form-control', type: 'text', placeholder: 'фио', 'aria-describedby': `scroll_item_span_${item_count}`}).appendTo(`#scroll_item_${item_count}`);
                }
            }
            else {
                document.getElementById(`head_office_${count}`).textContent = `Кабинет не выбран`;
                $("<div/>").attr({id: `records_${count}`, class: 'text-center'}).appendTo(`#col_${count}`);
                $("<h5/>").attr({id: `not_record_h5_${count}`, class: 'mb-3'}).appendTo(`#records_${count}`);
                document.getElementById(`not_record_h5_${count}`).textContent = 'Расписание отсутствует';
                $("<button/>").attr({id: `not_record_button_${count}`, class: 'btn btn-outline-primary', type: 'button', 'data-bs-toggle': 'modal', 'data-bs-target': `#modal`}).appendTo(`#records_${count}`);
                $("<i/>").attr({class: 'bx bx-calendar-edit'}).appendTo(`#not_record_button_${count}`);
                document.getElementById(`not_record_button_${count}`).textContent = 'Добавить';
            }
        }
    }
</script>

{% endblock %}

