{% extends 'base/base.html' %}

{% block content %}

<!-- <style>
.collapse {
  overflow: auto;
  width: auto;
  height: auto;
  max-height: 50vh;
  max-width: 100%;
}
</style> -->

<div class="container" id='main'>
    <form id="form" action="/search/search_process" onsubmit="find_user(); return false;">
        <div class="input-group mb-3">
            <input list="patient" placeholder="Поиск пациента" type="search" id="q" class="form-control" aria-describedby="search-button">
            <datalist id="patient">
                {% for i in patients %}
                <option value="{{ i.full_name }}">
                {% endfor %}
            </datalist>
            <button id="search-button" type="submit" class="btn btn-outline-primary">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </form>
    <div class="modal fade" id="modal" tabindex="-1" aria-labelledby="modal_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_label">Пациент</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id='cont'>
                    <div class="row mb-5">
                        <div class="col">
                            <form id='searchFormtest'>
                                <div id="sandbox-container" class="d-flex justify-content-center"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal_update" tabindex="-1" aria-labelledby="modal_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_label">Изменение данных о пациенте</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id='cont_update'>
                    <form id="form2" action="/search/edit_patient" onsubmit="add_user(); return false;">
                        <label for="fio" class="form-label"><h4>Первичные данные</h4></label>
                        <div class="row" id="fio">
                            <div class="col">
                                <label for="surname" class="form-label">Фамилия</label>
                                <input id="surname" type="text" class="form-control" required>
                            </div>
                            <div class="col">
                                <label for="name" class="form-label">Имя</label>
                                <input id="name" type="text" class="form-control" required>
                            </div>
                            <div class="col">
                                <label for="middlename" class="form-label">Отчество</label>
                                <input id="middlename" type="text" class="form-control" required>
                            </div>
                        </div>
                        <br>
                        <hr>
                        <br>
                        <label for="info" class="form-label"><h4>Краткая информация</h4></label>
                        <div class="row" id="info">
                            <div class="col">
                                <label for="birthday" class="form-label">День рождения</label>
                                <input id="birthday" type="date" class="form-control" max="3000-01-01" required>
                            </div>
                            <div class="col">
                                <label for="how_think" class="form-label">Как узнал?</label>
                                <select class="form-select" id="how_think" required>
                                    <option value="none" disabled>Выберите тип рекламы</option>
                                    <option value="secret">Неизвестно</option>
                                    <option value="sundress">Сарафан</option>
                                    <option value="ad">Реклама</option>
                                </select>
                            </div>
                            <div class="col">
                                <label for="address" class="form-label">Адрес</label>
                                <input id="address" type="text" class="form-control input" required>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col">
                                <label for="phone" class="form-label">Номер телефона</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1">+7</span>
                                    <input id="phone_m" type="text" class="form-control jmp__input_tel" aria-describedby="basic-addon1" required>
                                </div>
                            </div>
                            <div class="col">
                                <label for="phone2" class="form-label">Дополнительный номер телефона</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text" id="basic-addon1">+7</span>
                                    <input id="phone2" type="text" class="form-control jmp__input_tel" aria-describedby="basic-addon1">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-2">
                                <label for="card_number" class="form-label">Номер карты</label>
                                <div class="input-group mb-3">
                                    <input id="card_number" type="text" class="form-control" aria-describedby="basic-addon1" required>
                                </div>
                            </div>
                            <div class="col-sm-5">
                                <label for="email" class="form-label">Email</label>
                                <div class="input-group mb-3">
                                    <input id="email" type="text" class="form-control" aria-describedby="basic-addon1">
                                </div>
                            </div>
                            <div class="col-sm-5 d-flex justify-content-center align-items-center">
                                <div class="input-group">
                                    <div class="form-check">
                                        <input class="form-check-input" name='out_of_town' type="checkbox" id="out_of_town">
                                        <label class="form-check-label" for="out_of_town">Иногородний</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
 

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.ru.min.js"></script>  

<script>
    var current_date = moment().format('DD.MM.YYYY');
    var doc_select = '';
    var office_select = '';
    var user_select = '';
    var rec_id = '';
    var doctors = {};
    var patients = {};
    var trust = {};
    var all_doc = false;
    var uid = 0

    var user_role = '';
    var translate = {
            'default': 'Обычный',
            'child': 'Ребенок',
            'pregnant': 'Беременная'
        }

    $('#sandbox-container').datepicker({
        format: "dd.mm.yyyy",
        startView: 2,
        maxViewMode: 2,
        todayBtn: "linked",
        language: "ru",
        autoclose: true,
        todayHighlight: true,
    }).on('changeDate', showTestDate);


    function get_doctors(date) {
        url = '/reception/get_data'
        var posting = $.post( url, {'date': date});

        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["error"]("Произошла ошибка, пожалуйста попробуйте еще раз или обратитесь к администратору.", "Ошибка!");
            }
            else {
                for (let count = 0; count < data.doctors.length; count++) {
                    doctors[data.doctors[count].id] = data.doctors[count].name;
                }
                for (let count = 0; count < data['patients'].length; count++) {
                    patients[data['patients'][count].patient_full_name] = data['patients'][count].patient_id;
                    trust[data['patients'][count].patient_full_name] = data['patients'][count].trust_factor;
                }
                console.log(data);
                createForm(data);
            }
        });
    };


    function createForm(all_data) {
        data = all_data['data'];
        office_amount = all_data.data.amount + 1;
        delBlock2();
        $("<div/>").attr({id: 'data_place2'}).appendTo('#cont');
        $("<div/>").attr({id: 'row2', class: 'row align-items-stretch'}).appendTo('#data_place2');
        for (let count = 1; count < office_amount; count++) {
            if (data[count].records.length > 0) {    
                $("<div/>").attr({id: `col_${count}`, class: 'col-sm-4 mt-5 outer', style: 'min-height: 25vh; background-color: #edf1f5; -webkit-box-shadow: 4px 4px 30px 0px rgba(34, 60, 80, 0.2); -moz-box-shadow: 4px 4px 30px 0px rgba(34, 60, 80, 0.2); box-shadow: 4px 4px 30px 0px rgba(34, 60, 80, 0.2);"'}).appendTo(`#row2`);
                $("<div/>").attr({id: `head_${count}`}).appendTo(`#col_${count}`);
                $("<p/>").attr({id: `head_fio_${count}`, class: 'text-center mb-1 mt-2'}).appendTo(`#head_${count}`);
                document.getElementById(`head_fio_${count}`).textContent = data[count].doctor.doctor_full_name;
                $("<p/>").attr({id: `head_div_doc_${count}`, class: 'text-center'}).appendTo(`#head_${count}`);
                $("<p/>").attr({id: `head_office_${count}`, class: 'text-center'}).appendTo(`#head_${count}`);
                document.getElementById(`head_div_doc_${count}`).textContent = `${data[count].name}`;
                document.getElementById(`head_office_${count}`).textContent = `Кабинет №${count}`;
                $("<div/>").attr({id: `scroll_${count}`, class: 'overflow-auto mb-5', style: "max-height: 40vh; padding-right: 5px;"}).appendTo(`#col_${count}`);
                for (let item_count = 0; item_count < data[count].records.length; item_count++) {
                    if (data[count].records[item_count].is_active == 1) {
                        $("<div/>").attr({id: `scroll_item_${count}_${item_count}`, class: 'input-group input-group-sm mb-2'}).appendTo(`#scroll_${count}`);
                        if (moment() > moment(data[count].records[item_count].time, 'HH:mm')) {
                            $("<span/>").attr({id: `scroll_item_span_${count}_${item_count}`, class: 'input-group-text btn-secondary text-white'}).appendTo(`#scroll_item_${count}_${item_count}`);
                        }
                        else {
                            $("<span/>").attr({id: `scroll_item_span_${count}_${item_count}`, class: 'input-group-text btn-primary text-white'}).appendTo(`#scroll_item_${count}_${item_count}`);
                        }
                        document.getElementById(`scroll_item_span_${count}_${item_count}`).textContent = data[count].records[item_count].time;
                        $("<input/>").attr({list: `scroll_item_datalist_${count}_${item_count}`, 'rec_id': data[count].records[item_count].rec_id, id: `scroll_item_input_${count}_${item_count}`, class: 'form-control', type: 'text', 'aria-describedby': `scroll_item_${count}_${item_count}`}).appendTo(`#scroll_item_${count}_${item_count}`);
                        $("<datalist/>").attr({id: `scroll_item_datalist_${count}_${item_count}`}).appendTo(`#scroll_item_${count}_${item_count}`);
                        for (let patient_count = 0; patient_count < all_data['patients'].length; patient_count++) {
                            if (all_data['patients'][patient_count].patient_full_name) {
                                $("<option/>").attr({value: all_data['patients'][patient_count].patient_full_name}).appendTo(`#scroll_item_datalist_${count}_${item_count}`);
                            }
                        }
                        if (data[count].records[item_count].patient_full_name) {
                            if (trust[data[count].records[item_count].patient_full_name]) {
                                trust_factor_name = 'Надежный'
                            } 
                            else {
                                trust_factor_name = 'Не надежный'
                            }
                            $(`#scroll_item_input_${count}_${item_count}`).attr({'readonly': true, 'data-bs-toggle': 'tooltip', 'title': `Номер: <em>${data[count].records[item_count].phone}</em> Статус: <em>${trust_factor_name}</em>`});
                            if (data[count].records[item_count].is_interview == 1) {
                                if (data[count].records[item_count].is_go == 1) {
                                    $(`#scroll_item_input_${count}_${item_count}`).attr({'style': 'color: DarkGreen;', 'readonly': true, 'data-bs-toggle': 'tooltip', 'title': `Номер: <em>${data[count].records[item_count].phone}</em> Статус: <em>${trust_factor_name}</em>`});
                                }
                                else if (data[count].records[item_count].is_go == 0) {
                                    $(`#scroll_item_input_${count}_${item_count}`).attr({'style': 'color: OrangeRed;', 'readonly': true, 'data-bs-toggle': 'tooltip', 'title': `Номер: <em>${data[count].records[item_count].phone}</em> Статус: <em>${trust_factor_name}</em>`});
                                }
                            }
                            else {
                                if (!trust[data[count].records[item_count].patient_full_name]) {
                                    $(`#scroll_item_input_${count}_${item_count}`).attr({'style': 'color: red;', 'readonly': true, 'data-bs-toggle': 'tooltip', 'title': `Номер: <em>${data[count].records[item_count].phone}</em> Статус: <em>${trust_factor_name}</em>`});
                                }
                            }
                            $(`#scroll_item_input_${count}_${item_count}`).val(data[count].records[item_count].patient_full_name);
                            if (all_data['role'] == 'doctor') {        
                                $("<button/>").attr({'rec_id': data[count].records[item_count].rec_id, 'onclick': 'get_rec_id(this);', id: `scroll_item_button_edit_${count}_${item_count}`, class: 'btn btn-warning bx bx-history', type: 'button', 'data-bs-toggle': 'modal', 'data-bs-target': `#modal_came`}).appendTo(`#scroll_item_${count}_${item_count}`);
                                $("<button/>").attr({'rec_id': data[count].records[item_count].rec_id, 'onclick': 'get_rec_id(this);', id: `scroll_item_button_edit_${count}_${item_count}`, class: 'btn btn-danger bx bx-calendar-edit', type: 'button', 'data-bs-toggle': 'modal', 'data-bs-target': `#modal_accept`}).appendTo(`#scroll_item_${count}_${item_count}`);
                            }
                        }
                        else {
                            if (moment() < moment(data[count].records[item_count].time, 'HH:mm')) {
                                $("<button/>").attr({'onclick': 'addRecord(this);', 'input_id': `scroll_item_input_${count}_${item_count}`, id: `scroll_item_button_add_${count}_${item_count}`, class: 'btn btn-primary bx bx-calendar-plus', type: 'button'}).appendTo(`#scroll_item_${count}_${item_count}`);
                            } else {
                                $(`#scroll_item_input_${count}_${item_count}`).attr({'readonly': true, class: 'form-control', type: 'text', 'aria-describedby': `scroll_item_${count}_${item_count}`});
                            }
                        }
                    }
                }
            }
        }
    }


    function showTestDate() {
        current_date = $('#sandbox-container').datepicker('getFormattedDate');
        console.log(current_date)
        url = '/reception/get_data';

        var posting = $.post(url, { date: current_date} );
        
        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["error"]("Произошла ошибка, пожалуйста попробуйте еще раз или обратитесь к администратору.", "Ошибка!");
            }
            else {
                toastr["success"]("Успешно!");
                for (let count = 0; count < data.doctors.length; count++) {
                    doctors[data.doctors[count].id] = data.doctors[count].name;
                }
                for (let count = 0; count < data['patients'].length; count++) {
                    patients[data['patients'][count].patient_full_name] = data['patients'][count].patient_id;
                    trust[data['patients'][count].patient_full_name] = data['patients'][count].trust_factor;
                }
                createForm(data);
            }
        });
    };

    function addRecord(obj) {
        input_id = document.getElementById(obj.id).getAttribute('input_id');
        rec_id = document.getElementById(input_id).getAttribute('rec_id');
        user_full_name = $(`#${input_id}`).val();
        user_id = patients[user_full_name];
    
        url = '/reception/record';

        var posting = $.post(url, { 'rec_id': rec_id, 'patient_full_name': user_full_name, 'patient_id': user_id} );
        
        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["error"]("Произошла ошибка, пожалуйста попробуйте еще раз или обратитесь к администратору.", "Ошибка!");
            }
            else {
                find_user();
            }
        });
    };


    function delBlock3() {
        if ($('#data_place3').length) {
            $("#data_place3").empty();
        }
    }
    function load_user_info() {
        delBlock3()
        row_id = "data"
        $("<div/>").attr({id: 'data_place3'}).appendTo('#form2');
        $("<br>").appendTo('#data_place3');
        $("<hr>").appendTo('#data_place3');
        $("<br>").appendTo('#data_place3');
        $("<label/>").attr({class: 'form-label', for: row_id, id: 'data_label'}).appendTo('#data_place3');
        $("<h4/>").attr({id: 'data_label_h4'}).appendTo('#data_label');
        $("<div/>").attr({class: 'row', id: row_id}).appendTo('#data_place3');
        if (user_role == 'default' || user_role == 'pregnant') {
            document.getElementById('data_label_h4').textContent = 'Данные';
            counter = 0
            row_counter = 1
            if (user_role == 'default') {
                var data_list = Object.entries({
                    'lr_pass_num': 'Номер паспорта',
                    'lr_pass_serial': 'Серия паспорта',
                    'lr_pass_date': 'Дата получения паспорта',
                    'lr_pass_issued': 'Место получения паспорта'
                })
            }
            else {
                var data_list = Object.entries({
                    'lr_pass_num': 'Номер паспорта',
                    'lr_pass_serial': 'Серия паспорта',
                    'lr_pass_date': 'Дата получения паспорта',
                    'lr_pass_issued': 'Место получения паспорта',
                    'estimated_date': 'ПДР',
                    'num_fetus': 'Кол-во плодов'
                    
                })
            }
            for (var i = 0; i < data_list.length; i++) {
                if (counter == 2) {
                    row_id = 'data' + row_counter
                    $("<br>").appendTo('#data_place');
                    $("<div/>").attr({class: 'row', id: row_id}).appendTo('#data_place3');
                    i -= 1
                    counter = 0
                    row_counter += 1
                }
                else {
                    $("<div/>").attr({class: 'col', id: row_id + '_col_' + data_list[i][0]}).appendTo('#' + row_id);
                    $("<label/>").attr({class: 'form-label', for: data_list[i][0], id: data_list[i][0] + '_label'}).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                    document.getElementById(data_list[i][0]  + '_label').textContent = data_list[i][1];
                    if (data_list[i][0].includes('date')) {
                        $("<input/>").attr({class: 'form-control', id: data_list[i][0], type: 'date', max: "3000-01-01"}).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                    }
                    else {
                        $("<input/>").attr({class: 'form-control', id: data_list[i][0], type: 'text'}).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                    }
                    counter += 1
                }
            }
        }
        else if (user_role == 'child'){
            document.getElementById('data_label_h4').textContent = 'Данные о сопровождающем';
            counter = 0
            row_counter = 1
            var data_list = Object.entries({
                'lr_surname': 'Фамилия представителя',
                'lr_f_name': 'Имя представителя',
                'lr_l_name': 'Отчество представителя',
                'lr_select': 'Тип представителя',
                'lr_pass_num': 'Номер паспорта представителя',
                'lr_pass_serial': 'Серия паспорта представителя',
                'lr_pass_date': 'Дата получения паспорта представителя',
                'lr_pass_issued': 'Место получения паспорта представителя',
            })
            for (var i = 0; i < data_list.length; i++) {
                if (counter == 3) {
                    row_id = 'data' + row_counter
                    $("<br>").appendTo('#data_place3');
                    $("<div/>").attr({class: 'row', id: row_id}).appendTo('#data_place3');
                    i -= 1
                    counter = 0
                    row_counter += 1
                }
                else {
                    $("<div/>").attr({class: 'col', id: row_id + '_col_' + data_list[i][0]}).appendTo('#' + row_id);
                    $("<label/>").attr({class: 'form-label', for: data_list[i][0], id: data_list[i][0] + '_label'}).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                    document.getElementById(data_list[i][0]  + '_label').textContent = data_list[i][1];
                    if (data_list[i][0].includes('date')) {
                        $("<input/>").attr({class: 'form-control', id: data_list[i][0], type: 'date',  max: "3000-01-01"}).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                    }
                    else if (data_list[i][0].includes('select')) {
                        $("<select/>").attr({class: 'form-select', id: 'lr_s'}).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                        var lr_select = ['Мать', 'Отец', 'Дед']
                        let disabled_status = new Option('Выберите тип представителя', 0);
                        disabled_status.disabled = true
                        lr_s.append(disabled_status);
                        for (let count = 0; count < lr_select.length; count++) {
                            let new_status = new Option(lr_select[count], count + 1);
                            lr_s.append(new_status);
                        }
                    }
                    else {
                        $("<input/>").attr({class: 'form-control', id: data_list[i][0], type: 'text', }).appendTo('#' + row_id + '_col_' + data_list[i][0]);
                    }

                    counter += 1
                }
            }
        }
        $("<br>").appendTo('#data_place3');
        $("<label/>").attr({class: 'form-label', for: 'comment', id: 'comm'}).appendTo('#data_place3');
        document.getElementById("comm").textContent = 'Комментарий';
        $("<textarea/>").attr({class: 'form-control', id: 'comment', type: 'text'}).appendTo('#data_place3');
        $("<br>").appendTo('#data_place3');
        $("<div/>").attr({class: 'd-grid gap-2', id: 'btn'}).appendTo('#data_place3');
        $("<button/>").attr({class: 'btn btn-outline-primary', id: 'answer', type: 'submit'}).appendTo('#btn');
        document.getElementById("answer").textContent = 'Отправить';
        $("<br>").appendTo('#data_place3');

    };



    function delBlock2() {
        if ($('#data_place2').length) {
            $("#data_place2").empty();
        }
    }

    function delBlock() {
        if ($('#data_place').length) {
            $("#data_place").empty();
        }
    }

    function find_user() {
        var $form = $( '#form' ),
            url = $form.attr( "action" );
        var posting = $.post( url, {'data' : $('#q').val()} );

        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["warning"]("Пользователь не найден.", "Предупреждение!");
            }
            else {
                outputData(data.patients[0]);
                console.log(data.patients);
                toastr["success"]("Успешно!");
                user_role = data.patients[0].role;
                uid = data.patients[0].id

                get_doctors(moment().format('DD.MM.YYYY'));
                load_user_info();
            }
        });
    };

    function getTrustFactor(factor) {
        if (factor)
            return "Положительный"
        else
            return "Отрицательный"
    }

    function outputData(data) {
        delBlock();
        $("<div/>").attr({id: 'data_place'}).appendTo('#main');
        $("<div/>").attr({id: 'card_main', class: 'card border-primary mb-3'}).appendTo('#data_place');
        $("<div/>").attr({id: 'card_header', class: 'card-header bg-transparent border-primary text-center'}).appendTo('#card_main');
        document.getElementById('card_header').textContent = data.full_name;
        $("<div/>").attr({id: 'card_body', class: 'card-body'}).appendTo('#card_main');
        $("<div/>").attr({id: 'card_body_row', class: 'row'}).appendTo('#card_body');
        $("<div/>").attr({id: 'card_body_col_1', class: 'col'}).appendTo('#card_body_row');
        $("<div/>").attr({id: 'card_body_col_2', class: 'col'}).appendTo('#card_body_row');
        $("<h3/>").attr({id: 'short_info', class: 'text-center lead'}).appendTo('#card_body_col_1');
        document.getElementById('short_info').textContent = 'Краткая информация';
        $("<ul/>").attr({id: 'card_header', class: 'list-group list-group-flush'}).appendTo('#card_body_col_1');
        $("<li/>").attr({id: 'card_text_type', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_type').textContent = `Тип пациента "${translate[data.role]}"`;
        $("<li/>").attr({id: 'card_text_bd', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_bd').textContent = `Дата рождения: ${data.birthday}`;
        $("<li/>").attr({id: 'card_text_age', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_age').textContent = `Возраст: ${data.age}`;
        $("<li/>").attr({id: 'card_text_tf', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_tf').textContent = `Фактор доверия: ${getTrustFactor(data.trust_factor)}`;
        $("<li/>").attr({id: 'card_text_phone', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_phone').textContent = `Номер телефона: ${data.phone}`;
        $("<li/>").attr({id: 'card_text_phone2', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_phone2').textContent = `Дополнительный номер телефона: ${data.phone2}`;
        $("<li/>").attr({id: 'card_text_address', class: 'list-group-item'}).appendTo('#card_body_col_1');
        document.getElementById('card_text_address').textContent = `Адрес: ${data.address}`;
        $("<li/>").attr({id: 'card_text_comment', class: 'list-group-item my-3'}).appendTo('#card_body');
        document.getElementById('card_text_comment').textContent = `${data.comment}`;
        
        $("<h3/>").attr({id: 'data_info', class: 'text-center lead'}).appendTo('#card_body_col_2');
        if (data.role == 'default') {
            document.getElementById('data_info').textContent = 'Данные о пациенте';
            $("<ul/>").attr({id: 'card_header', class: 'list-group list-group-flush'}).appendTo('#card_body_col_2');
            $("<li/>").attr({id: 'card_text_lr_pass_serial', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_serial').textContent = `Серия паспорта: ${data.lr_pass_serial}`;
            $("<li/>").attr({id: 'card_text_lr_pass_num', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_num').textContent = `Номер паспорта: ${data.lr_pass_num}`;
            $("<li/>").attr({id: 'card_text_lr_pass_date', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_date').textContent = `Дата выдачи: ${data.lr_pass_date}`;
            $("<li/>").attr({id: 'card_text_lr_pass_issued', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_issued').textContent = `Кем выдан: ${data.lr_pass_issued}`;
        }
        else if (data.role == 'pregnant') {
            document.getElementById('data_info').textContent = 'Данные о пациенте';
            $("<ul/>").attr({id: 'card_header', class: 'list-group list-group-flush'}).appendTo('#card_body_col_2');
            $("<li/>").attr({id: 'card_text_lr_pass_serial', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_serial').textContent = `Серия паспорта: ${data.lr_pass_serial}`;
            $("<li/>").attr({id: 'card_text_lr_pass_num', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_num').textContent = `Номер паспорта: ${data.lr_pass_num}`;
            $("<li/>").attr({id: 'card_text_lr_pass_date', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_date').textContent = `Дата выдачи: ${data.lr_pass_date}`;
            $("<li/>").attr({id: 'card_text_lr_pass_issued', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_issued').textContent = `Кем выдан: ${data.lr_pass_issued}`;
            $("<li/>").attr({id: 'card_text_estimated_birthday', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_estimated_birthday').textContent = `ПДР: ${data.estimated_birthday}`;
            $("<li/>").attr({id: 'card_text_num_fetus', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_num_fetus').textContent = `Кол-во плодов: ${data.num_fetus}`;
        }
        else if (data.role == 'child') {
            document.getElementById('data_info').textContent = 'Данные о представителе';
            $("<ul/>").attr({id: 'card_header', class: 'list-group list-group-flush'}).appendTo('#card_body_col_2');
            $("<li/>").attr({id: 'card_text_lr_pass_serial', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_serial').textContent = `Серия паспорта: ${data.lr_pass_serial}`;
            $("<li/>").attr({id: 'card_text_lr_pass_num', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_num').textContent = `Номер паспорта: ${data.lr_pass_num}`;
            $("<li/>").attr({id: 'card_text_lr_pass_date', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_date').textContent = `Дата выдачи: ${data.lr_pass_date}`;
            $("<li/>").attr({id: 'card_text_lr_pass_issued', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_pass_issued').textContent = `Кем выдан: ${data.lr_pass_issued}`;
            $("<li/>").attr({id: 'card_text_lr_status', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_status').textContent = `Тип представителя: "${translate[data.role]}"`;
            $("<li/>").attr({id: 'card_text_lr_full_name', class: 'list-group-item'}).appendTo('#card_body_col_2');
            document.getElementById('card_text_lr_full_name').textContent = `ФИО: ${data.r_full_name}`;
        }
        $("<button/>").attr({id: 'card_btn', class: 'btn btn-outline-primary w-100 mb-3', type: 'button', 'data-bs-toggle': 'modal', 'data-bs-target': `#modal_update` }).appendTo('#card_body');
        document.getElementById('card_btn').textContent = `Изменить данные о пациенте`;
        $("<div/>").attr({id: 'card_footer', class: 'card-footer bg-transparent border-primary'}).appendTo('#card_main');
        $("<div/>").attr({id: 'row', class: 'row'}).appendTo('#card_footer');
        if (data.lost_records.length > 0 || data.future_records.length > 0) {
            if (data.lost_records.length > 0) {
                $("<div/>").attr({id: 'col_1_data', class: 'col'}).appendTo('#row');
                $("<label/>").attr({id: 'old_label', class: 'form-label', for: 'old_record'}).appendTo('#col_1_data');
                $("<b/>").attr({id: 'b_old_label'}).appendTo('#old_label');
                document.getElementById('b_old_label').textContent = 'Прошедшие записи';
                $("<div/>").attr({id: 'old_record', class: 'accordion accordion-flush'}).appendTo('#col_1_data');
                for (let i = 0; i < data.lost_records.length; i++) {
                    $("<div/>").attr({id: 'old_accordion_item' + i, class: 'accordion-item'}).appendTo('#old_record');
                    $("<h2/>").attr({id: 'old_accordion_item_header' + i, class: 'accordion-header'}).appendTo('#old_accordion_item' + i);
                    $("<button/>").attr({id: 'old_btn_' + i, class: 'accordion-button collapsed', type: 'button', 'data-bs-toggle': 'collapse', 'data-bs-target': '#old_text_' + i, 'aria-expanded': 'false', 'aria-controls': 'old_text_' + i}).appendTo('#old_accordion_item_header' + i);
                    document.getElementById('old_btn_' + i).textContent = `${data.lost_records[i].date} [${data.lost_records[i].time}]`;
                    $("<div/>").attr({id: 'old_text_' + i, class: 'accordion-collapse collapse'}).appendTo('#old_accordion_item' + i);
                    $("<div/>").attr({id: 'old_doctor_full_name_' + i, class: 'accordion-body'}).appendTo('#old_text_' + i);
                    document.getElementById('old_doctor_full_name_' + i).textContent = `Доктор: ${data.lost_records[i].doctor_full_name}`;
                    $("<div/>").attr({id: 'old_office_' + i, class: 'accordion-body'}).appendTo('#old_text_' + i);
                    document.getElementById('old_office_' + i).textContent = `Кабинет: ${data.lost_records[i].office}`;
                }
            }
            if (data.future_records.length > 0) {
                $("<div/>").attr({id: 'col_2_data', class: 'col'}).appendTo('#row');
                $("<label/>").attr({id: 'future_label', class: 'form-label', for: 'future_record'}).appendTo('#col_2_data');
                $("<b/>").attr({id: 'b_future_label'}).appendTo('#future_label');
                document.getElementById('b_future_label').textContent = 'Текущие записи';
                $("<div/>").attr({id: 'future_record', class: 'accordion accordion-flush'}).appendTo('#col_2_data');
                for (let i = 0; i < data.future_records.length; i++) {
                    console.log(data.future_records[i].date)
                    $("<div/>").attr({id: 'future_accordion_item' + i, class: 'accordion-item'}).appendTo('#future_record');
                    $("<h2/>").attr({id: 'future_accordion_item_header' + i, class: 'accordion-header'}).appendTo('#future_accordion_item' + i);
                    $("<button/>").attr({id: 'future_btn_' + i, class: 'accordion-button collapsed', type: 'button', 'data-bs-toggle': 'collapse', 'data-bs-target': '#future_text_' + i, 'aria-expanded': 'false', 'aria-controls': 'future_text_' + i}).appendTo('#future_accordion_item_header' + i);
                    document.getElementById('future_btn_' + i).textContent = `${data.future_records[i].date} [${data.future_records[i].time}]`;
                    $("<div/>").attr({id: 'future_text_' + i, class: 'accordion-collapse collapse'}).appendTo('#future_accordion_item' + i);
                    $("<div/>").attr({id: 'future_doctor_full_name_' + i, class: 'accordion-body'}).appendTo('#future_text_' + i);
                    document.getElementById('future_doctor_full_name_' + i).textContent = `Доктор: ${data.future_records[i].doctor_full_name}`;
                    $("<div/>").attr({id: 'future_office_' + i, class: 'accordion-body'}).appendTo('#future_text_' + i);
                    document.getElementById('future_office_' + i).textContent = `Кабинет: ${data.future_records[i].office}`;
                }
            }
        }
        else {
            $("<h3/>").attr({id: 'footer_text', class: 'text-center lead'}).appendTo('#row');
            document.getElementById('footer_text').textContent = 'У данного пациента отсутствуют записи!';
            $("<button/>").attr({id: 'footer_btn', class: 'btn btn-outline-primary', type: 'button', 'data-bs-toggle': 'modal', 'data-bs-target': `#modal`}).appendTo('#row');
            document.getElementById('footer_btn').textContent = 'Добавить';
        }
    }
    function add_user() {
        var $form = $( '#form2' ),
            url = $form.attr( "action" );
        if (user_role == 'default') {
            var full_data = {
                'surname': $form.find( "#surname" ).val(),
                'name': $form.find( "#name" ).val(),
                'middlename': $form.find( "#middlename" ).val(),
                'birthday': moment($form.find( "#birthday" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'how_think': $form.find( "#how_think" ).val(),
                'address': $form.find( "#address" ).val(),
                'phone': '+7 ' + $form.find( "#phone" ).val(),
                'phone2': '+7 ' + $form.find( "#phone2" ).val(),
                'card_number': $form.find( "#card_number" ).val(),
                'email': $form.find( "#email" ).val(),
                'out_of_town': $form.find( "#out_of_town" ).is(':checked'),
                'lr_surname': '',
                'lr_f_name': '',
                'lr_l_name': '',
                'lr_s': '',
                'lr_pass_num': $form.find( "#lr_pass_num" ).val(),
                'lr_pass_serial': $form.find( "#lr_pass_serial" ).val(),
                'lr_pass_date': moment($form.find( "#lr_pass_date" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'lr_pass_issued': $form.find( "#lr_pass_issued" ).val(),
                'num_fetus': '',
                'estimated_date': '',
                'comment': $form.find( "#comment" ).val(),
                'uid': uid,
                'type': user_role
            }
        }
        else if (user_role == 'pregnant') {
            var full_data = {
                'surname': $form.find( "#surname" ).val(),
                'name': $form.find( "#name" ).val(),
                'middlename': $form.find( "#middlename" ).val(),
                'birthday': moment($form.find( "#birthday" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'how_think': $form.find( "#how_think" ).val(),
                'address': $form.find( "#address" ).val(),
                'phone': '+7 ' + $form.find( "#phone" ).val(),
                'phone2': '+7 ' + $form.find( "#phone2" ).val(),
                'card_number': $form.find( "#card_number" ).val(),
                'email': $form.find( "#email" ).val(),
                'out_of_town': $form.find( "#out_of_town" ).is(':checked'),
                'lr_surname': '',
                'lr_f_name': '',
                'lr_l_name': '',
                'lr_s': '',
                'lr_pass_num': $form.find( "#lr_pass_num" ).val(),
                'lr_pass_serial': $form.find( "#lr_pass_serial" ).val(),
                'lr_pass_date': moment($form.find( "#lr_pass_date" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'lr_pass_issued': $form.find( "#lr_pass_issued" ).val(),
                'num_fetus': $form.find( "#num_fetus" ).val(),
                'estimated_date': moment($form.find( "#estimated_date" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'comment': $form.find( "#comment" ).val(),
                'uid': uid,
                'type': user_role
            }
        }
        else if (user_role == 'child') {
            var full_data = {
                'surname': $form.find( "#surname" ).val(),
                'name': $form.find( "#name" ).val(),
                'middlename': $form.find( "#middlename" ).val(),
                'birthday': moment($form.find( "#birthday" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'how_think': $form.find( "#how_think" ).val(),
                'address': $form.find( "#address" ).val(),
                'phone': '+7 ' + $form.find( "#phone" ).val(),
                'phone2': '+7 ' + $form.find( "#phone2" ).val(),
                'card_number': $form.find( "#card_number" ).val(),
                'email': $form.find( "#email" ).val(),
                'out_of_town': $form.find( "#out_of_town" ).is(':checked'),
                'lr_surname': $form.find( "#lr_surname" ).val(),
                'lr_f_name': $form.find( "#lr_f_name" ).val(),
                'lr_l_name': $form.find( "#lr_l_name" ).val(),
                'lr_s': $form.find( "#lr_s" ).val(),
                'lr_pass_num': $form.find( "#lr_pass_num" ).val(),
                'lr_pass_serial': $form.find( "#lr_pass_serial" ).val(),
                'lr_pass_date': moment($form.find( "#lr_pass_date" ).val(), "YYYY-MM-DD").format('DD.MM.YYYY'),
                'lr_pass_issued': $form.find( "#lr_pass_issued" ).val(),
                'num_fetus': '',
                'estimated_date': '',
                'comment': $form.find( "#comment" ).val(),
                'uid': uid,
                'type': user_role
            }
        }

        var posting = $.post( url, {data: full_data} );

        posting.done(function( data ) {
            if (data.success == "false") {
                toastr["error"]("Что-то пошло не так, попробуйте еще раз или обратитесь к администратору.", "Ошибка!");
            }
            else {
                toastr["success"]("Пациент занесен в базу данных", "Успешно!");
            }
        });
    };

    
</script>

{% endblock %}


